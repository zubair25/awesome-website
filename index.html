<!-- YEH AAP KE INDEX.HTML KE AKHRI HISSE MEIN SCRIPT TAG KE ANDAR AAYEGA -->
<script>
    // --- Baki sara code waisa hi rahega (DOM elements, Page Management, etc.) ---
    const ctaButton = document.getElementById('ctaButton');
    const userProfile = document.getElementById('userProfile');
    const signupNavLi = document.getElementById('signupNavLi'); 
    const redirectMessage = document.getElementById('redirectMessage'); 
    const profileDropdownEmail = document.getElementById('profileDropdownEmail');
    const profileImageInput = document.getElementById('profileImageInput');
    const mainProfilePicContainer = document.getElementById('profilePic');
    const dropdownAvatarContainer = document.querySelector('.profile-avatar');

    // --- AUTHENTICATION STATE MANAGEMENT (Ab server se link hoga) ---
    const authState = {
        isAuthenticated: false,
        userEmail: null,
        
        init() {
            // Ab hum page load par session se check karenge, localStorage se nahi
            const authData = sessionStorage.getItem('authData'); // Session storage behtar hai
            if (authData) {
                const { isAuthenticated, userEmail } = JSON.parse(authData);
                this.isAuthenticated = isAuthenticated;
                this.userEmail = userEmail;
            }
            updateNavigationState(); 
            loadProfilePicture();
        },
        
        login(email) {
            this.isAuthenticated = true;
            this.userEmail = email;
            this.save();
            updateNavigationState(); 
        },
        
        logout() {
            this.isAuthenticated = false;
            this.userEmail = null;
            sessionStorage.removeItem('authData');
            sessionStorage.removeItem('profileImageData');
            updateNavigationState(); 
            resetProfilePictures();
        },
        
        save() {
            const authData = JSON.stringify({
                isAuthenticated: this.isAuthenticated,
                userEmail: this.userEmail
            });
            sessionStorage.setItem('authData', authData);
        }
    };
    // ... (Yahan baki sara code jaise updateNavigationState, logoutUser, etc. waisa hi rahega)
    function updateNavigationState() {
        if (authState.isAuthenticated) {
            ctaButton.style.display = 'none';
            userProfile.style.display = 'block';
            signupNavLi.style.display = 'none'; 
            profileDropdownEmail.textContent = authState.userEmail;
        } else {
            ctaButton.style.display = 'inline-flex';
            userProfile.style.display = 'none';
            signupNavLi.style.display = 'list-item'; 
        }
    }
    function logoutUser() {
        if (confirm("Are you sure you want to log out?")) {
            authState.logout();
            alert("You have been successfully logged out.");
            showMainPage();
        }
    }
    // ... (profile picture aur page management ka code bhi waisa hi rahega)
    function uploadProfileImage() { profileImageInput.click(); }
    profileImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
            const imageDataUrl = reader.result;
            sessionStorage.setItem('profileImageData', imageDataUrl);
            updateProfilePictures(imageDataUrl);
        };
        reader.readAsDataURL(file);
    });

    function updateProfilePictures(imageDataUrl) {
        mainProfilePicContainer.innerHTML = `<img src="${imageDataUrl}" alt="Profile Picture">`;
        dropdownAvatarContainer.innerHTML = `<img src="${imageDataUrl}" alt="Profile Picture">`;
    }

    function resetProfilePictures() {
        mainProfilePicContainer.innerHTML = `<i class="fas fa-user"></i>`;
        dropdownAvatarContainer.innerHTML = `<i class="fas fa-user"></i>`;
    }

    function loadProfilePicture() {
        const savedImage = sessionStorage.getItem('profileImageData');
        if (savedImage && authState.isAuthenticated) {
            updateProfilePictures(savedImage);
        }
    }
    const mainPageDiv = document.getElementById('mainPage');
    const toolPageDiv = document.getElementById('toolPage');
    const signupPageDiv = document.getElementById('signupPage');

    function showMainPage() {
        mainPageDiv.style.display = 'flex';
        toolPageDiv.style.display = 'none';
        signupPageDiv.style.display = 'none';
        window.scrollTo(0, 0); 
    }
    function showToolPage(toolType) {
        if (!authState.isAuthenticated) {
            showSignupPage(true); 
            return;
        }
        mainPageDiv.style.display = 'none';
        signupPageDiv.style.display = 'none';
        toolPageDiv.style.display = 'block';
        let toolTitle = 'SEO Tool';
        switch(toolType) {
            case 'email-verifier': toolTitle = 'Visual Bulk Email Verifier'; break;
            case 'image-to-text': toolTitle = 'Image to Text Converter'; break;
            case 'da-pa-checker': toolTitle = 'DA PA Checker'; break;
        }
        document.querySelector('#toolPage h1').innerHTML = `<i class="fas fa-${getToolIcon(toolType)}"></i> ${toolTitle}`;
        window.scrollTo(0, 0); 
    }
    function getToolIcon(toolType) {
        switch(toolType) {
            case 'email-verifier': return 'envelope';
            case 'image-to-text': return 'image';
            case 'da-pa-checker': return 'chart-line';
            default: return 'toolbox';
        }
    }
    function showSignupPage(fromToolRedirect = false) {
        redirectMessage.style.display = fromToolRedirect ? 'block' : 'none';
        mainPageDiv.style.display = 'none';
        toolPageDiv.style.display = 'none';
        signupPageDiv.style.display = 'block';
        document.getElementById('signupStep1').style.display = 'block';
        document.getElementById('signupStep2').style.display = 'none';
        document.getElementById('signupForm').reset();
        errorMsg.style.display = 'none';
        errorMsg2.style.display = 'none';
        window.scrollTo(0, 0); 
    }
    authState.init();
    // ... (Dropdown, Email Verifier Tool ka code bhi waisa hi rakhein)


    // --- YAHAN SE NAYA AUR BEHTAR SIGNUP/LOGIN LOGIC SHURU HOTA HAI ---
    
    const signupStep1 = document.getElementById('signupStep1');
    const signupStep2 = document.getElementById('signupStep2');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const otpInputs = document.querySelectorAll('.otp-input');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const errorMsg = document.getElementById('errorMsg');
    const errorMsg2 = document.getElementById('errorMsg2');
    const togglePassword = document.getElementById('togglePassword');
    const otpEmailDisplay = document.getElementById('otpEmailDisplay');
    const continueBtn = document.getElementById('continueBtn');
    const backBtn = document.getElementById('backBtn');

    // 'Continue' button par click karne se server se baat hogi
    continueBtn.addEventListener('click', async () => {
        const email = signupEmail.value.trim();
        const password = signupPassword.value.trim();
        errorMsg.style.display = 'none';

        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) || password.length < 6) {
            errorMsg.textContent = 'Please enter a valid email and a password of at least 6 characters.';
            errorMsg.style.display = 'block';
            return;
        }

        continueBtn.disabled = true;
        continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

        try {
            const response = await fetch('/.netlify/functions/auth-handler', {
                method: 'POST',
                body: JSON.stringify({ email, password }),
            });

            const result = await response.json();

            if (response.ok) {
                if (result.status === 'LOGGED_IN') {
                    // Login kamyab
                    authState.login(email);
                    alert(result.message);
                    showToolPage('email-verifier');
                } else if (result.status === 'OTP_SENT') {
                    // OTP bhej diya gaya, ab OTP screen dikhayen
                    otpEmailDisplay.textContent = email;
                    signupStep1.style.display = 'none';
                    signupStep2.style.display = 'block';
                    otpInputs[0].focus();
                    alert("A verification code has been sent. For testing, check the server logs on Netlify for the OTP.");
                }
            } else {
                // Server se error aaya
                errorMsg.textContent = result.message || 'An error occurred.';
                errorMsg.style.display = 'block';
            }
        } catch (err) {
            errorMsg.textContent = 'Could not connect to the server. Please try again.';
            errorMsg.style.display = 'block';
        }

        continueBtn.disabled = false;
        continueBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Continue';
    });

    // OTP Verify button par click
    verifyOtpBtn.addEventListener('click', async () => {
        const email = signupEmail.value.trim();
        let otp = Array.from(otpInputs).map(input => input.value).join('');
        errorMsg2.style.display = 'none';

        if (otp.length !== 6) {
            errorMsg2.textContent = 'Please enter the 6-digit code.';
            errorMsg2.style.display = 'block';
            return;
        }

        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

        try {
             const response = await fetch('/.netlify/functions/auth-handler', {
                method: 'POST',
                body: JSON.stringify({ email, otp }),
            });
            const result = await response.json();

            if (response.ok && result.status === 'ACCOUNT_CREATED') {
                authState.login(email);
                alert(result.message);
                showToolPage('email-verifier');
            } else {
                errorMsg2.textContent = result.message || 'Verification failed.';
                errorMsg2.style.display = 'block';
            }

        } catch(err) {
             errorMsg2.textContent = 'Could not connect to the server.';
             errorMsg2.style.display = 'block';
        }
        
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify & Create Account';
    });
    
    togglePassword.addEventListener('click', () => {
        const type = signupPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        signupPassword.setAttribute('type', type);
        togglePassword.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
    });

    otpInputs.forEach((input, index) => {
        input.addEventListener('input', () => {
            if (input.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && input.value === '' && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
    });

    backBtn.addEventListener('click', () => {
        signupStep2.style.display = 'none';
        signupStep1.style.display = 'block';
        errorMsg.style.display = 'none';
        errorMsg2.style.display = 'none';
    });
</script>
